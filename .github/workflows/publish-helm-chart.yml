name: Publish Helm Chart

on:
  push:
    paths:
      - 'charts/**'
      - 'Chart.yaml'

jobs:
  release-chart:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Set up Helm
      uses: azure/setup-helm@v1

    - name: Package Helm Chart
      run: |
        helm package ./charts/k8sman-agent -d ./charts

    - name: Reindex Helm Repo
      run: |
        helm repo index ./charts --url https://ovrdoz.github.io/k8sman-helm-chart/charts/
    
    - name: Check for modified files
      id: git-check
      run: echo ::set-output name=modified::$(if [ -n "$(git status --porcelain)" ]; then echo "true"; else echo "false"; fi)

    - name: Commit Charts Directory
      if: steps.git-check.outputs.modified == 'true'
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add ./charts/
        git commit -m "Publish updated Helm chart [skip ci]"
        git push 

